/*************************************************
 * Détail de la loi -- lecture lois_AI.json (+ fallback)
 * - Enlève l'ID dans le header
 * - Affiche noms réels dans "Députés porteurs"
 * - Résumé & impacts depuis lois_AI.json si dispo
 *************************************************/

const URL_LOIS_AI  = "./lois/lois_AI.json";
const URL_LOIS     = "./lois/lois.json";
const URL_DEPUTES  = "./deputes/deputes.json";
const URL_GROUPES  = "./deputes/groupes.json";

const $ = (s) => document.querySelector(s);
const setText = (sel, val, placeholder="--") => {
  const el = $(sel); if (!el) return;
  el.textContent = (val == null || val === "") ? placeholder : val;
  el.classList.remove("skeleton");
  el.style.removeProperty("height");
};

// ID demandé dans l'URL
const urlId = new URLSearchParams(location.search).get("id")?.toUpperCase();

// Fonction d’unification d’ID (doit être la même partout)
function idOf(l){
  return String(
    l?.ref ||
    l?.cid ||
    l?.dossierLegislatifRef ||
    l?.reference ||
    l?.id ||
    l?.numero ||
    l?.code
  ).toUpperCase();
}

// Maps auteurs
let MAP_DEPUTES = {}; // { PAxxxx -> "Nom" }
let MAP_GROUPES = {}; // { POxxxx -> "Sigle -- Libellé" }

// Auteur lisible
function formatAuteur(code){
  if (!code) return "--";
  if (MAP_DEPUTES[code]) return MAP_DEPUTES[code];
  if (MAP_GROUPES[code]) return MAP_GROUPES[code];
  if (/^PO\d{3,}$/.test(code)) return "Gouvernement"; // fallback fréquent
  return code;
}

async function fetchJSON(u){
  const r = await fetch(u, {cache:"no-store"});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function loadMaps(){
  try{
    const dep = await fetchJSON(URL_DEPUTES);
    (Array.isArray(dep) ? dep : []).forEach(d=>{
      if (d.id && d.nom) MAP_DEPUTES[String(d.id)] = d.nom;
    });
  }catch(e){/* ignore */}

  try{
    const grp = await fetchJSON(URL_GROUPES);
    (Array.isArray(grp) ? grp : []).forEach(g=>{
      if (!g.code) return;
      const label = g.sigle ? (g.libelle ? `${g.sigle} -- ${g.libelle}` : g.sigle)
                            : (g.libelle || g.code);
      MAP_GROUPES[String(g.code)] = label;
    });
  }catch(e){/* ignore */}
}

function fillAuthors(containerSel, obj){
  const el = $(containerSel); if (!el) return;
  // champs possibles : auteurs[] OU auteur
  let auteurs = [];
  if (Array.isArray(obj.auteurs) && obj.auteurs.length) {
    auteurs = obj.auteurs;
  } else if (obj.auteur) {
    auteurs = [obj.auteur];
  }
  if (!auteurs.length) {
    el.classList.add("muted");
    el.textContent = "--";
    return;
  }
  el.classList.remove("muted");
  el.innerHTML = auteurs
    .map(code => `<span class="chip">${escapeHTML(formatAuteur(String(code)))}</span>`)
    .join(" ");
}

function escapeHTML(s){
  return (s ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

(async function main(){
  // Titre par défaut si id absent
  if (!urlId) {
    setText("#title", "Loi introuvable");
    setText("#subtitle", "");
    return;
  }

  try{
    await loadMaps();

    // 1) On essaie d'abord lois_AI.json (avec résumé + impacts)
    let item = null;
    try{
      const ai = await fetchJSON(URL_LOIS_AI);
      const arr = Array.isArray(ai) ? ai : [];
      item = arr.find(x => String(x.id || x.ref || x.cid || x.reference || "").toUpperCase() === urlId);
    }catch(_){/* pas grave, on tente la base */}

    // 2) Sinon fallback sur lois.json
    if (!item) {
      const base = await fetchJSON(URL_LOIS);
      const list = Array.isArray(base) ? base : (base.lois || base.items || []);
      item = list.find(x => idOf(x) === urlId);
    }

    if (!item) throw new Error("Loi non trouvée");

    // ===== Header (sans l'ID !) =====
    setText("#title", item.titre || "Sans titre");
    const subtitle = [item.type, item.date].filter(Boolean).join(" · ");
    setText("#subtitle", subtitle, "");

    // ===== Députés porteurs (noms) =====
    fillAuthors("#deputes", item);

    // ===== Résumé / Impacts (si dispo dans AI) =====
    if (item.resume) {
      setText("#resume", item.resume, "Résumé non disponible.");
    } else {
      setText("#resume", "Résumé non disponible.");
    }

    const impactsEl = $("#impacts");
    if (Array.isArray(item.impacts) && item.impacts.length) {
      impactsEl.innerHTML = item.impacts.map(x => `<li>${escapeHTML(x)}</li>`).join("");
    } else {
      impactsEl.innerHTML = `<li class="muted">--</li>`;
    }

    // ===== Badges =====
    setText("#statut", item.etat || item.statut || "--");
    setText("#nature", item.type || item.nature || "--");

    const datesEl = $("#dates");
    const d = item.date || item.dates || null;
    datesEl.innerHTML = d ? `<li>${escapeHTML(String(d))}</li>` : `<li class="muted">--</li>`;

    // ===== Lien officiel =====
    const a = $("#legifrance");
    if (item.url) {
      a.href = item.url;
      a.target = "_blank";
      a.rel = "noopener";
    } else {
      a.href = "#";
      a.textContent = "Lien indisponible";
      a.classList.add("muted");
      a.removeAttribute("target");
      a.removeAttribute("rel");
    }
  }catch(e){
    console.error(e);
    setText("#title", "Loi introuvable");
    setText("#subtitle", "");
    setText("#resume", "Impossible de charger les données.");
    $("#impacts").innerHTML = `<li class="muted">--</li>`;
  }
})();