<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test acteurs AN -- recherche par code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb; --ink:#0f172a; --mut:#6b7280; --panel:#fff;
      --line:#e5e7eb; --accent:#0d6efd; --ring:rgba(13,110,253,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:var(--accent);color:#fff;padding:18px 16px;z-index:10;box-shadow:0 2px 10px rgba(13,110,253,.25)}
    header h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:16px auto;padding:0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #q{flex:1 1 420px;min-width:240px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    #q:focus{outline:none;box-shadow:0 0 0 4px var(--ring);border-color:#bcd1ff}
    .muted{color:var(--mut)}
    .count{margin:8px 2px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top}
    th{background:#f9fafb;text-align:left;font-weight:700}
    tr:last-child td{border-bottom:none}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .badge{display:inline-block;padding:.2rem .5rem;border:1px solid var(--line);border-radius:999px;font-size:12px;margin-right:6px;background:#f8fafc}
  </style>
</head>
<body>
  <header>
    <h1>Test acteurs AN -- recherche par code</h1>
  </header>

  <main>
    <div class="row">
      <input id="q" type="search" placeholder="Rechercher (code, nom, type, rôles)…" />
      <div class="count muted" id="count">--</div>
    </div>

    <table aria-label="Liste des acteurs AN">
      <thead>
        <tr>
          <th style="width:160px">Code</th>
          <th>Nom / Libellé</th>
          <th style="width:160px">Type</th>
          <th>Rôles</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4" class="muted">Chargement…</td></tr>
      </tbody>
    </table>
  </main>

  <script>
    // -------- utils d’affichage sûrs --------
    function normalize(val){
      if (val == null) return '';
      if (typeof val === 'string') return val;
      if (typeof val === 'number' || typeof val === 'boolean') return String(val);
      if (typeof val === 'object'){
        // cas fréquent: { "#text": "PA1206" }
        if (Object.prototype.hasOwnProperty.call(val, '#text')) return String(val['#text'] ?? '');
        // si c’est déjà un objet simple "code": { value: "PA1206" }
        if (Object.prototype.hasOwnProperty.call(val, 'value')) return String(val.value ?? '');
        try { return JSON.stringify(val); } catch { return String(val); }
      }
      return String(val);
    }
    function joinText(parts, sep=' · '){
      return parts.filter(Boolean).map(normalize).filter(Boolean).join(sep);
    }
    function roleLabel(role){
      if (!role) return '';
      if (typeof role === 'string') return role;
      if (typeof role === 'object'){
        // on privilégie libQualite sinon codeQualite
        return normalize(role.libQualite || role.codeQualite || role.titre || role);
      }
      return String(role);
    }
    function escapeHTML(s){
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // -------- rendu du tableau --------
    const tbody = document.getElementById('tbody');
    const countEl = document.getElementById('count');
    let DATA = [];

    function render(list){
      if (!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Aucun résultat.</td></tr>`;
        countEl.textContent = '0 résultat';
        return;
      }
      const rows = list.map(a=>{
        const code = normalize(a.code) || '--';
        const nom  = normalize(a.nom || a.libelle) || '--';
        const type = normalize(a.type) || '--';

        let rolesHTML = '<span class="muted">--</span>';
        if (Array.isArray(a.roles) && a.roles.length){
          rolesHTML = a.roles.map(r => `<span class="badge">${escapeHTML(roleLabel(r))}</span>`).join(' ');
        } else if (a.role) {
          rolesHTML = `<span class="badge">${escapeHTML(roleLabel(a.role))}</span>`;
        }

        return `<tr>
          <td class="code">${escapeHTML(code)}</td>
          <td>${escapeHTML(nom)}</td>
          <td>${escapeHTML(type)}</td>
          <td>${rolesHTML}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
      countEl.textContent = `${list.length} résultat${list.length>1?'s':''}`;
    }

    // -------- recherche --------
    const q = document.getElementById('q');
    function search(){
      const term = q.value.trim().toLowerCase();
      if (!term){ render(DATA); return; }
      const res = DATA.filter(a=>{
        const code = normalize(a.code).toLowerCase();
        const nom  = normalize(a.nom || a.libelle).toLowerCase();
        const type = normalize(a.type).toLowerCase();
        const rolesText = Array.isArray(a.roles)
          ? a.roles.map(r => roleLabel(r)).join(' ').toLowerCase()
          : normalize(a.role).toLowerCase();
        return code.includes(term) || nom.includes(term) || type.includes(term) || rolesText.includes(term);
      });
      render(res);
    }
    q.addEventListener('input', search);

    // -------- chargement du JSON --------
    (async function init(){
      try{
        const resp = await fetch('./data/an_actors.json', {cache:'no-store'});
        if (!resp.ok) throw new Error('HTTP '+resp.status);
        const raw = await resp.json();

        // an_actors.json peut contenir { acteurs: [...] } ou directement un tableau
        const arr = Array.isArray(raw) ? raw : (raw.acteurs || raw.items || []);
        DATA = arr.map(x => ({
          code:  x.code,
          nom:   x.nom || x.libelle,
          type:  x.type,
          roles: Array.isArray(x.roles) ? x.roles : (x.roles ? [x.roles] : [])
        }));

        render(DATA);
      }catch(e){
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Erreur de chargement.</td></tr>`;
        countEl.textContent = '--';
      }
    })();
  </script>
</body>
</html>