<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test acteurs AN -- recherche par code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fb; --ink:#0f172a; --muted:#6b7280; --panel:#fff;
      --border:#e5e7eb; --accent:#0d6efd; --ring:rgba(13,110,253,.28);
      --radius:12px; --shadow:0 8px 30px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:5;background:var(--accent);color:#fff;padding:18px 16px;box-shadow:0 2px 12px rgba(13,110,253,.25)}
    .top h1{margin:0;font-size:20px}
    .wrap{max-width:1100px;margin:14px auto;padding:0 12px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="search"]{flex:1 1 420px;min-width:240px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    input[type="search"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer}
    .pill[aria-pressed="true"]{background:#eef4ff;border-color:#c7d8ff}
    .count{color:var(--muted);font-size:14px;margin-top:6px}

    .table{margin-top:10px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    th{background:#f8fafc;text-align:left;font-weight:700;font-size:14px;color:#111827}
    td{font-size:15px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header class="top">
    <div class="wrap"><h1>Test acteurs AN -- recherche par code</h1></div>
  </header>

  <main class="wrap">
    <div class="bar">
      <input id="q" type="search" placeholder="Rechercher (code, nom, type, rôles)…" />
      <button class="pill" id="f-all" aria-pressed="true">Tout</button>
      <button class="pill" id="f-pa"  aria-pressed="false">Acteurs (PA)</button>
      <button class="pill" id="f-po"  aria-pressed="false">Organes (PO)</button>
    </div>
    <div class="count" id="count">--</div>

    <section class="table">
      <table aria-live="polite">
        <thead>
          <tr>
            <th style="width:140px">Code</th>
            <th>Nom / Libellé</th>
            <th style="width:160px">Type</th>
            <th>Rôles</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="4" class="muted">Chargement…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
  (()=>{
    const $ = s => document.querySelector(s);
    const rowsEl = $("#rows");
    const countEl = $("#count");
    const qEl = $("#q");
    const pills = { all: $("#f-all"), pa: $("#f-pa"), po: $("#f-po") };

    let RAW = [];   // brut du JSON
    let DATA = [];  // normalisé (code/nom/type/roles[])
    let filterType = "all"; // all | pa | po
    let q = "";

    const normText = v => (v ?? "").toString();
    const textOf = v => (typeof v === "object" && v) ? (v["#text"] ?? v._ ?? "") : v;

    function normalizeEntry(x){
      // code / uid parfois objets: {"#text":"PA1206"}
      const rawCode = x.code ?? x.uid ?? "";
      const code = normText(textOf(rawCode)).toUpperCase();

      // Type lisible
      const type =
        x.type ?? x.codeType ??
        (code.startsWith("PA") ? "Acteur" :
         code.startsWith("PO") ? "Organe" : "");

      // Nom / libellé
      const nom =
        x.nom ??
        x.libelle ??
        x.libelleEdition ??
        (x.etatCivil && x.etatCivil.ident && (x.etatCivil.ident.nom || x.etatCivil.ident.prenom) ?
          [x.etatCivil.ident.prenom, x.etatCivil.ident.nom].filter(Boolean).join(" ") : "") ??
        "";

      // Rôles (tableau de chaînes)
      let roles = [];
      if (Array.isArray(x.roles)) {
        roles = x.roles.map(r => typeof r === "string" ? r : (r.lib || r.type || JSON.stringify(r)));
      } else if (x.mandats && Array.isArray(x.mandats)) {
        roles = x.mandats.map(m => m.typeOrgane || m.type || "").filter(Boolean);
      }
      return { code, nom: normText(nom), type: normText(type), roles };
    }

    async function load(){
      try{
        const url = "data/an_actors.json?v=" + Date.now();
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        RAW = await r.json();

        // Certains builds stockent la liste sous {items:[]}
        const arr = Array.isArray(RAW) ? RAW : (RAW.items || RAW.data || []);
        DATA = arr.map(normalizeEntry).filter(e => e.code);

        render();
      }catch(e){
        rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Erreur de chargement.</td></tr>`;
        console.error(e);
      }
    }

    function applyFilters(){
      let list = DATA;
      if (filterType === "pa") list = list.filter(x => x.code.startsWith("PA"));
      if (filterType === "po") list = list.filter(x => x.code.startsWith("PO"));

      const needle = q.trim().toLowerCase();
      if (needle){
        list = list.filter(x =>
          x.code.toLowerCase().includes(needle) ||
          x.nom.toLowerCase().includes(needle)  ||
          x.type.toLowerCase().includes(needle) ||
          (x.roles.join(" • ").toLowerCase().includes(needle))
        );
      }
      return list;
    }

    function render(){
      const list = applyFilters();
      countEl.textContent = `${list.length} résultat${list.length>1?"s":""}`;

      if (!list.length){
        rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Aucun résultat.</td></tr>`;
        return;
      }

      rowsEl.innerHTML = list.map(x => `
        <tr>
          <td>${escapeHTML(x.code)}</td>
          <td>${escapeHTML(x.nom || "--")}</td>
          <td>${escapeHTML(x.type || "--")}</td>
          <td>${escapeHTML(x.roles && x.roles.length ? x.roles.join(" • ") : "--")}</td>
        </tr>
      `).join("");
    }

    function setFilter(type){
      filterType = type;
      pills.all.setAttribute("aria-pressed", type==="all");
      pills.pa .setAttribute("aria-pressed", type==="pa");
      pills.po .setAttribute("aria-pressed", type==="po");
      render();
    }

    function escapeHTML(s){ return (s??"").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

    // Events
    pills.all.addEventListener("click", ()=>setFilter("all"));
    pills.pa .addEventListener("click", ()=>setFilter("pa"));
    pills.po .addEventListener("click", ()=>setFilter("po"));

    let t;
    qEl.addEventListener("input", e=>{
      clearTimeout(t);
      t = setTimeout(()=>{ q = e.target.value || ""; render(); }, 120);
    });

    load();
  })();
  </script>
</body>
</html>