<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test acteurs AN -- recherche par code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --ink:#111827; --muted:#6b7280;
      --accent:#0d6efd; --ring:rgba(13,110,253,.25); --border:#e5e7eb;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:10;background:var(--accent);color:#fff;padding:14px 16px;box-shadow:0 2px 12px rgba(13,110,253,.28)}
    .topbar h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:14px auto;padding:0 12px 36px}
    #q{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    #q:focus{outline:none;box-shadow:0 0 0 4px var(--ring);border-color:var(--accent)}
    .meta{display:flex;justify-content:space-between;align-items:center;margin:10px 2px;color:var(--muted);font-size:13px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead th{background:#f8fafc;text-align:left;font-weight:700;border-bottom:1px solid var(--border);padding:10px 12px;font-size:14px}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:var(--muted)}
    .err{color:#b91c1c}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;margin:2px 6px 2px 0;background:#f8fafc;font-size:12px}
  </style>
</head>
<body>
  <header class="topbar">
    <h1>Test acteurs AN -- recherche par code</h1>
  </header>

  <main class="wrap">
    <input id="q" type="search" placeholder="Rechercher (code, nom, type, rôles)…" aria-label="Rechercher" />
    <div class="meta"><span id="count">--</span><span id="status" class="muted"></span></div>

    <section class="panel">
      <table aria-live="polite">
        <thead>
          <tr>
            <th style="width:140px">Code</th>
            <th>Nom / Libellé</th>
            <th style="width:160px">Type</th>
            <th>Rôles</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">Chargement…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // Emplacements possibles du JSON
    const REL_URL = './data/an_actors.json';
    const ABS_URL = 'https://teiki5320.github.io/loi/data/an_actors.json';

    const $ = (s)=>document.querySelector(s);
    const tbody = $('#tbody');
    const q = $('#q');
    const countEl = $('#count');
    const statusEl = $('#status');

    let DATA = [];     // tableau complet
    let VIEW = [];     // vue filtrée

    // Chargement JSON avec fallback REL -> ABS
    async function loadData(){
      statusEl.textContent = 'Chargement…';
      let resp;
      try {
        resp = await fetch(REL_URL, {cache:'no-store'});
        if (!resp.ok) throw new Error('REL non ok');
      } catch {
        resp = await fetch(ABS_URL, {cache:'no-store'});
      }
      if (!resp.ok) throw new Error('Échec de chargement JSON');
      return resp.json();
    }

    function normalizeRole(r){
      if (!r) return '';
      if (typeof r === 'string') return r;
      try { return JSON.stringify(r); } catch { return String(r); }
    }

    function render(list){
      if (!Array.isArray(list) || !list.length){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Aucun résultat.</td></tr>`;
        countEl.textContent = '0 résultat';
        return;
      }
      const rows = list.map(a=>{
        const code = a.code ?? '--';
        const nom  = a.nom || a.libelle || '--';
        const type = a.type || '--';
        const roles = Array.isArray(a.roles) && a.roles.length
          ? a.roles.map(r=>`<span class="badge">${normalizeRole(r)}</span>`).join('')
          : '<span class="muted">--</span>';
        return `<tr>
          <td class="code">${code}</td>
          <td>${nom}</td>
          <td>${type}</td>
          <td>${roles}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
      countEl.textContent = `${list.length} résultat${list.length>1?'s':''}`;
    }

    function filter(term){
      const t = term.trim().toLowerCase();
      if (!t){ VIEW = DATA.slice(); return render(VIEW); }
      VIEW = DATA.filter(a=>{
        const code = (a.code||'').toLowerCase();
        const nom  = (a.nom||a.libelle||'').toLowerCase();
        const type = (a.type||'').toLowerCase();
        const roles = (Array.isArray(a.roles)?a.roles:[]).join(' ').toLowerCase();
        return code.includes(t) || nom.includes(t) || type.includes(t) || roles.includes(t);
      });
      render(VIEW);
    }

    // Init
    (async function(){
      try{
        DATA = await loadData();
        // petite validation minimale
        if (!Array.isArray(DATA)) throw new Error('JSON inattendu (pas un tableau)');
        // tri simple par code
        DATA.sort((a,b)=>String(a.code||'').localeCompare(String(b.code||'')));
        statusEl.textContent = '';
        filter('');
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="4" class="err">Erreur de chargement.</td></tr>`;
        statusEl.textContent = '';
        countEl.textContent = '--';
      }
    })();

    // Recherche temps réel (debounce léger)
    let tId;
    q.addEventListener('input', e=>{
      clearTimeout(tId);
      tId = setTimeout(()=>filter(e.target.value), 120);
    });
  </script>
</body>
</html>