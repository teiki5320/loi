<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test acteurs AN -- recherche par code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f5f7fb;--panel:#fff;--ink:#0f172a;--muted:#6b7280;--border:#e5e7eb;--accent:#0d6efd}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:var(--accent);color:#fff;padding:16px 20px;box-shadow:0 2px 10px rgba(0,0,0,.15)}
    header h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:16px auto;padding:0 16px}
    .top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #q{flex:1 1 420px;min-width:260px;padding:10px;border:1px solid var(--border);border-radius:10px}
    .count{color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border)}
    th{background:#f8fafc;text-align:left;color:#111827;font-weight:700}
    tr:hover{background:#f9fafb}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <header><h1>Test acteurs AN -- recherche par code</h1></header>
  <main>
    <div class="top">
      <input id="q" type="search" placeholder="Rechercher (code, nom, type, rôles)…" />
      <div class="count" id="count"></div>
    </div>
    <div style="margin-top:10px;overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:160px">Code</th>
            <th>Nom / Libellé</th>
            <th style="width:180px">Type</th>
            <th>Rôles</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
      </table>
    </div>
  </main>

  <script>
    // Helpers: extraction sûre du code, du nom/libellé, des rôles et du type
    const getCode = (it) => {
      if (typeof it.code === 'string') return it.code;
      if (it.code && typeof it.code === 'object') {
        return it.code['#text'] || it.code.text || it.code.value || '';
      }
      // fallback: parfois on a uid côté organe/acteur
      if (typeof it.uid === 'string') return it.uid;
      if (it.uid && typeof it.uid === 'object') return it.uid['#text'] || '';
      return '';
    };

    const getNom = (it) => it.nom || it.name || it.libelle || it.libelleEdition || '';

    const getType = (it) => {
      // ton build peut avoir it.type ; sinon devine à partir des rôles
      if (it.type) return it.type;
      const roles = (it.roles || []).join(' · ');
      if (/déput/i.test(roles)) return 'Député';
      if (/sénat/i.test(roles)) return 'Sénateur';
      if (/ministre/i.test(roles)) return 'Ministre';
      return it.categorie || '';
    };

    const getRoles = (it) => {
      if (Array.isArray(it.roles) && it.roles.length) return it.roles.join(' · ');
      return '';
    };

    let ALL = [];

    async function load() {
      const res = await fetch('./data/an16/an_actors.json?v=' + Date.now(), {cache:'no-store'});
      const raw = await res.json();

      // Normalisation: fabrique un tableau propre {code, nom, type, rolesStr}
      ALL = (Array.isArray(raw) ? raw : []).map(it => {
        const code = getCode(it);
        const nom = getNom(it);
        const type = getType(it);
        const rolesStr = getRoles(it);
        return { code, nom, type, rolesStr };
      });

      render(ALL);
      document.getElementById('q').addEventListener('input', onSearch);
    }

    function onSearch(e){
      const q = e.target.value.trim().toLowerCase();
      if (!q){
        render(ALL);
        return;
      }
      const f = ALL.filter(x =>
        (x.code||'').toLowerCase().includes(q) ||
        (x.nom||'').toLowerCase().includes(q)  ||
        (x.type||'').toLowerCase().includes(q) ||
        (x.rolesStr||'').toLowerCase().includes(q)
      );
      render(f);
    }

    function render(list){
      const rows = document.getElementById('rows');
      const cnt = document.getElementById('count');
      cnt.textContent = `${list.length} résultat${list.length>1?'s':''}`;
      if (!list.length){
        rows.innerHTML = `<tr><td colspan="4" class="muted">Aucun résultat.</td></tr>`;
        return;
      }
      rows.innerHTML = list.map(x => `
        <tr>
          <td class="code">${escapeHTML(x.code || '--')}</td>
          <td>${escapeHTML(x.nom || '--')}</td>
          <td>${escapeHTML(x.type || '--')}</td>
          <td>${escapeHTML(x.rolesStr || '--')}</td>
        </tr>
      `).join('');
    }

    function escapeHTML(s){
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    load().catch(err=>{
      console.error(err);
      document.getElementById('rows').innerHTML =
        `<tr><td colspan="4" class="muted">Erreur de chargement.</td></tr>`;
    });
  </script>
</body>
</html>