<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Test acteurs AN -- recherche par code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --ink:#0f172a; --muted:#6b7280; --card:#fff;
      --border:#e5e7eb; --ring:rgba(59,130,246,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#0d6efd;color:#fff;padding:18px}
    header h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:16px auto;padding:0 12px}
    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .toolbar input{
      flex:1 1 360px; min-width:260px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff;
    }
    .toolbar input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 4px var(--ring)}
    .count{color:var(--muted);font-size:14px}

    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead th{background:#f3f4f6;text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    tbody td{padding:10px 12px;border-top:1px solid var(--border);vertical-align:top}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .badge{display:inline-block;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:3px 8px;margin:2px 6px 2px 0;font-size:12px}
  </style>
</head>
<body>
  <header><h1>Test acteurs AN -- recherche par code</h1></header>

  <main>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Rechercher (code, nom, rôle)…" />
      <div class="count" id="count"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:140px">Code</th>
          <th>Nom</th>
          <th style="width:180px">Type</th>
          <th>Rôles</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="4" class="muted">Chargement…</td></tr>
      </tbody>
    </table>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const rows = $("#rows");
    const countEl = $("#count");
    let DATA = [];

    // Essaie d'extraire un libellé lisible depuis un rôle qui peut être string OU objet
    function roleLabel(r){
      if (!r) return "";
      if (typeof r === "string") return r;
      if (typeof r === "number") return String(r);
      if (r.label)   return r.label;
      if (r.libelle) return r.libelle;
      if (r.fonction) return r.fonction;
      if (r.type && r.code) return `${r.type} ${r.code}`;
      try { return JSON.stringify(r); } catch { return ""; }
    }

    // Déduit un "type" court : Député / Sénateur / Ministre / Organe / Acteur
    function guessType(item){
      const code = String(item.code || "");
      // D’abord via rôles explicites
      const roles = Array.isArray(item.roles) ? item.roles.map(roleLabel).join(" ").toLowerCase() : "";
      if (/(déput|depute)/.test(roles))   return "Député";
      if (/sénat|senat|sénateur|senateur/.test(roles)) return "Sénateur";
      if (/ministre/.test(roles))         return "Ministre";

      // Sinon via le préfixe du code
      if (code.startsWith("PO")) return "Organe";
      if (code.startsWith("PA")) return "Acteur";

      return "--";
    }

    function render(list){
      if (!list.length){
        rows.innerHTML = `<tr><td colspan="4" class="muted">Aucun résultat.</td></tr>`;
        countEl.textContent = "0 résultat";
        return;
      }
      rows.innerHTML = list.map(it => {
        const code = it.code || "--";
        const nom  = it.nom && it.nom.trim() ? it.nom : "--";
        const type = guessType(it);
        const roles = (Array.isArray(it.roles) && it.roles.length)
          ? it.roles.map(roleLabel).filter(Boolean).map(x => `<span class="badge">${escapeHTML(x)}</span>`).join("")
          : "<span class='muted'>--</span>";
        return `
          <tr>
            <td class="code">${escapeHTML(code)}</td>
            <td>${escapeHTML(nom)}</td>
            <td>${escapeHTML(type)}</td>
            <td>${roles}</td>
          </tr>`;
      }).join("");
      countEl.textContent = `${list.length} résultat${list.length>1?"s":""}`;
    }

    function escapeHTML(s){
      return (s ?? "").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    function filt(){
      const q = ($("#q").value || "").trim().toLowerCase();
      if (!q) return render(DATA);
      const hit = DATA.filter(it => {
        const code = String(it.code||"").toLowerCase();
        const nom  = String(it.nom||"").toLowerCase();
        const roles= Array.isArray(it.roles) ? it.roles.map(roleLabel).join(" ").toLowerCase() : "";
        return code.includes(q) || nom.includes(q) || roles.includes(q);
      });
      render(hit);
    }

    // Charge le JSON fusionné
    (async function init(){
      try{
        // adapte le chemin si nécessaire
        const r = await fetch("./data/an_actors.json?v="+Date.now());
        if (!r.ok) throw new Error("HTTP "+r.status);
        const arr = await r.json();
        DATA = Array.isArray(arr) ? arr : [];
      }catch(e){
        console.error(e);
        DATA = [];
      }
      render(DATA);
      $("#q").addEventListener("input", filt);
    })();
  </script>
</body>
</html>